apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: load-shed-slo-alerts
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: load-shed.slo
    rules:
    - alert: LoadShedBreakerOpenTooLong
      expr: max_over_time(circuit_breaker_state{job="load-shed-api"}[2m]) > 0
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "Circuit breaker open for > 2m"
        description: "Breaker stayed open for more than 2 minutes. Users may see degraded behavior (short-circuit responses) and upstream dependency may be unhealthy."

    - alert: LoadShedHighClient5xxRate
      expr: |
        (
          sum(rate(http_requests_total{job="load-shed-api",path="/client",status=~"5.."}[5m]))
          /
          clamp_min(sum(rate(http_requests_total{job="load-shed-api",path="/client"}[5m])), 1)
        ) > 0.02
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "High 5xx rate on /client (> 2%)"
        description: "User-facing errors are elevated. This can indicate upstream outage, breaker mis-tuning, or capacity issues."

    - alert: LoadShedUpstreamP95TooHigh
      expr: |
        histogram_quantile(
          0.95,
          sum by (le) (rate(upstream_request_duration_seconds_bucket{job="load-shed-api"}[5m]))
        ) > 0.5
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Upstream p95 latency > 500ms"
        description: "Dependency latency is high. This is an early symptom that often precedes timeouts, breaker opening, and 5xx."

